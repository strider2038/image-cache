parameters:
    image_cache.base_directory: '%test.web_directory%'

services:
    # external
    filesystem:
        class: \Symfony\Component\Filesystem\Filesystem

    # core components
    stream_factory:
        class: Strider2038\ImgCache\Core\Streaming\StreamFactory
    file_operations:
        class: Strider2038\ImgCache\Core\FileOperations
        arguments:
            - '@filesystem'
            - '@stream_factory'
    response_factory:
        class: Strider2038\ImgCache\Core\Http\ResponseFactory
        arguments:
            - '@request'
            - '@stream_factory'
            - '@file_operations'

    # utilities
    metadata_reader:
        class: Strider2038\ImgCache\Utility\MetadataReader
    guzzle_client_adapter:
        class: Strider2038\ImgCache\Utility\GuzzleClientAdapter
        arguments:
            - '@client_mock'
            - '@stream_factory'

    # service
    image_controller:
        class: Strider2038\ImgCache\Service\ImageController
        arguments:
            - '@response_factory'
            - '@image_action_factory'
    image_action_factory:
        class: Strider2038\ImgCache\Service\Image\ImageActionFactory
        arguments:
            - '@image_action_get'
            - '@image_action_create'
            - '@image_action_replace'
            - '@image_action_delete'
    image_action_get:
        class: Strider2038\ImgCache\Service\Image\GetAction
        arguments:
            - '@response_factory'
            - '@image_storage'
            - '@image_cache'
    image_action_create:
        class: Strider2038\ImgCache\Service\Image\CreateAction
        arguments:
            - '@response_factory'
            - '@image_storage'
            - '@image_factory'
    image_action_replace:
        class: Strider2038\ImgCache\Service\Image\ReplaceAction
        arguments:
            - '@response_factory'
            - '@image_storage'
            - '@image_cache'
            - '@image_factory'
    image_action_delete:
        class: Strider2038\ImgCache\Service\Image\DeleteAction
        arguments:
            - '@response_factory'
            - '@image_storage'
            - '@image_cache'

    # imaging
    image_storage:
        class: Strider2038\ImgCache\Imaging\ImageStorage
        arguments:
            - '@thumbnail_image_extractor'
            - '@thumbnail_image_writer'
    image_cache:
        class: Strider2038\ImgCache\Imaging\ImageCache
        arguments:
            - '%image_cache.base_directory%'
            - '@file_operations'
            - '@image_processor'

    # imaging/image
    image_factory:
        class: Strider2038\ImgCache\Imaging\Image\ImageFactory
        arguments:
            - '@save_options_factory'
            - '@image_validator'
            - '@file_operations'
            - '@stream_factory'

    # imaging/extraction
    thumbnail_image_extractor:
        class: Strider2038\ImgCache\Imaging\Extraction\ThumbnailImageExtractor
        arguments:
          - '@thumbnail_key_parser'
          - '@filesystem_storage_accessor'
          - '@image_processor'

    # imaging/insertion
    thumbnail_image_writer:
        class: Strider2038\ImgCache\Imaging\Insertion\ThumbnailImageWriter
        arguments:
            - '@thumbnail_key_parser'
            - '@filesystem_storage_accessor'

    # imaging/parsing
    thumbnail_key_parser:
        class: Strider2038\ImgCache\Imaging\Parsing\Thumbnail\ThumbnailKeyParser
        arguments:
            - '@key_validator'
            - '@image_validator'
            - '@thumbnail_processing_configuration_parser'
    thumbnail_processing_configuration_parser:
        class: Strider2038\ImgCache\Imaging\Parsing\Processing\ThumbnailProcessingConfigurationParser
        arguments:
            - '@transformations_creator'
            - '@save_options_factory'
            - '@save_options_configurator'

    # imaging/processing
    save_options_factory:
        class: Strider2038\ImgCache\Imaging\Processing\SaveOptionsFactory
    save_options_configurator:
        class: Strider2038\ImgCache\Imaging\Parsing\SaveOptionsConfigurator
    image_processor:
        class: Strider2038\ImgCache\Imaging\Processing\ImageProcessor
        arguments:
            - '@imagick_transformer_factory'
            - '@image_factory'
    imagick_transformer_factory:
        class: Strider2038\ImgCache\Imaging\Processing\Imagick\ImagickTransformerFactory
        arguments:
            - '@file_operations'
            - '@stream_factory'

    # imaging/transformation
    transformations_creator:
        class: Strider2038\ImgCache\Imaging\Transformation\TransformationCreator
        arguments: ['@transformation_factory_flyweight']
    transformation_factory_flyweight:
        class: Strider2038\ImgCache\Imaging\Transformation\TransformationFactoryFlyweight

    # imaging/storage
    filesystem_storage_accessor:
        class: Strider2038\ImgCache\Imaging\Storage\Accessor\FilesystemStorageAccessor
        arguments:
            - '@filesystem_storage_driver'
            - '@image_factory'
            - '@direct_key_mapper'
    filesystem_storage_driver:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAVStorageDriver
        arguments:
            - '%filesystem_storage_driver.base_directory%'
            - '@webdav_resource_manipulator'
            - '@webdav_resource_checker'
    direct_key_mapper:
        class: Strider2038\ImgCache\Imaging\Storage\Data\DirectKeyMapper

    ## imaging/storage/webdav
    webdav_request_options_factory:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAV\RequestOptionsFactory
        arguments:
            - '@metadata_reader'
    webdav_xml_response_parser:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAV\XmlResponseParser
    webdav_resource_properties_getter:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAV\ResourcePropertiesGetter
        arguments:
            - '@guzzle_client_adapter'
            - '@webdav_xml_response_parser'
    webdav_resource_manipulator:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAV\ResourceManipulator
        arguments:
            - '@guzzle_client_adapter'
            - '@webdav_request_options_factory'
    webdav_resource_checker:
        class: Strider2038\ImgCache\Imaging\Storage\Driver\WebDAV\ResourceChecker
        arguments:
            - '@webdav_resource_properties_getter'

    # imaging/validation
    image_validator:
        class: Strider2038\ImgCache\Imaging\Validation\ImageValidator
    key_validator:
        class: Strider2038\ImgCache\Imaging\Validation\KeyValidator
